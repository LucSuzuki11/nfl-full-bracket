<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFL Playoff Pool — Full Bracket</title>
  <style>
    :root{
      --border:#e3e3e3;
      --text:#111;
      --muted:#666;
      --bg:#fff;
      --card:#fafafa;
      --accent:#111;
      --ok:#0a7a2f;
      --err:#b00020;
      --line:#cfcfcf;
    }

    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 16px; color:var(--text); background:var(--bg); }
    h1 { font-size: 20px; margin: 0 0 6px 0; }
    .muted { color: var(--muted); font-size: 14px; }
    .topbar { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin: 10px 0 14px 0; }
    input[type="text"]{ padding:10px; border:1px solid #ccc; border-radius:10px; width:240px; }
    button{ padding:12px 14px; border:0; border-radius:12px; background:var(--accent); color:#fff; font-weight:700; cursor:pointer; }
    .status { margin-top:10px; font-weight:700; }
    .ok { color: var(--ok); }
    .error { color: var(--err); }

    /* Outer wrap */
    .bracketWrap{
      position: relative;
      border:1px solid var(--border);
      border-radius:16px;
      padding: 14px;
      background:#fff;
      overflow:hidden;
    }

    /* 3 columns: AFC | SB | NFC  */
    .bracketGrid{
      display:grid;
      grid-template-columns: 1fr 360px 1fr;
      gap: 18px;
      align-items:start;
    }

    /* Side panels */
    .side{
      border:1px solid var(--border);
      border-radius:14px;
      padding: 12px;
      background:#fff;
    }
    .sideHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .sideHeader h2{ font-size:16px; margin:0; }
    .roundLabels{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      color:var(--muted);
      font-size:12px;
    }
    .roundLabels div{ text-align:center; }

    /* Each side is a 3x12 grid of slots */
    .sideGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: repeat(12, 26px);
      gap: 10px;
      position: relative;
      min-width: 0;
    }

    /* Super Bowl center */
    .center{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      height: fit-content;
      position: sticky;
      top: 12px;
      min-width: 0;
    }
    .center h2{ font-size:16px; margin:0 0 6px 0; }
    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.25;
    }

    /* --- SIMPLER GAME CARD --- */
    .game{
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      background:var(--card);
      height: 100%;
      box-sizing: border-box;
      min-width: 0;
    }
    .match{
      display:grid;
      grid-template-columns: 1fr 54px;
      gap:8px;
      align-items:center;
      margin: 6px 0;
      min-width: 0;
    }
    .pick{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:8px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      font-weight:800;
    }
    .picked{
      border-color:#111;
      box-shadow: 0 0 0 2px rgba(17,17,17,.10) inset;
    }
    .logo{
      width:18px;
      height:18px;
      object-fit:contain;
      flex:0 0 auto;
    }
    .label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .seed{
      font-weight:900;
      color:var(--muted);
      margin-right:6px;
    }
    .score{
      width:54px;
      padding:8px;
      border:1px solid #ccc;
      border-radius:10px;
      font-size:14px;
    }
    .placeholder{
      opacity:.55;
      font-weight:700;
      color:var(--muted);
    }

    /* Slot positioning (2 rows tall) */
    .slot{ grid-row: auto / span 2; min-width:0; }

    /* AFC (moves left -> right toward center) */
    #afc_wc1 { grid-column: 1; grid-row: 2 / span 2; }
    #afc_wc2 { grid-column: 1; grid-row: 5 / span 2; }
    #afc_wc3 { grid-column: 1; grid-row: 8 / span 2; }
    #afc_div1{ grid-column: 2; grid-row: 3 / span 2; }
    #afc_div2{ grid-column: 2; grid-row: 7 / span 2; }
    #afc_conf1{ grid-column: 3; grid-row: 5 / span 2; }

    /* NFC MUST move right -> left toward center
       So: WC in column 3, DIV in column 2, CONF in column 1 */
    #nfc_wc1 { grid-column: 3; grid-row: 2 / span 2; }
    #nfc_wc2 { grid-column: 3; grid-row: 5 / span 2; }
    #nfc_wc3 { grid-column: 3; grid-row: 8 / span 2; }
    #nfc_div1{ grid-column: 2; grid-row: 3 / span 2; }
    #nfc_div2{ grid-column: 2; grid-row: 7 / span 2; }
    #nfc_conf1{ grid-column: 1; grid-row: 5 / span 2; }

    /* Connector lines overlay */
    svg.connector{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* Debug frame (hide later) */
    #resultFrame{
      width:100%;
      height:110px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:12px;
      background:#fff;
    }

    @media (max-width: 1100px){
      .bracketGrid{ grid-template-columns: 1fr; }
      .center{ position: static; }
      .roundLabels{ display:none; }
      .sideGrid{ grid-template-columns: 1fr; grid-template-rows: none; }
      /* On mobile, slots will stack; lines won't matter */
      svg.connector{ display:none; }
    }
  </style>
</head>
<body>
  <h1>NFL Playoff Pool — Full Bracket</h1>
  <div class="muted">
    Click winners + enter scores. Reseeding: <b>#1 plays the lowest remaining seed</b>. (No ties.)
  </div>

  <div class="topbar">
    <label>
      <div class="muted">Your name</div>
      <input id="name" type="text" placeholder="Your name" />
    </label>

    <button id="submitBtn">Submit Full Bracket</button>
    <div id="status" class="status muted"></div>
  </div>

  <div class="bracketWrap" id="bracketWrap">
    <div class="bracketGrid">
      <!-- AFC -->
      <section class="side" id="afcSide">
        <div class="sideHeader">
          <h2>AFC</h2>
          <div class="muted" style="font-size:12px;">WC → DIV → CONF</div>
        </div>
        <div class="roundLabels">
          <div>Wild Card</div><div>Divisional</div><div>Conference</div>
        </div>

        <div class="sideGrid" id="afcGrid">
          <svg class="connector" id="afcLines"></svg>
          <div class="slot" id="afc_wc1"></div>
          <div class="slot" id="afc_wc2"></div>
          <div class="slot" id="afc_wc3"></div>
          <div class="slot" id="afc_div1"></div>
          <div class="slot" id="afc_div2"></div>
          <div class="slot" id="afc_conf1"></div>
        </div>

        <div class="note">#1 seed Denver Broncos has a bye.</div>
      </section>

      <!-- Super Bowl -->
      <section class="center" id="centerCol">
        <h2>Super Bowl</h2>
        <div class="muted" style="font-size:12px; margin-bottom:10px;">AFC Champ vs NFC Champ</div>
        <div id="sb_game"></div>
        <div class="note">Home/away doesn’t matter.</div>

        <iframe id="resultFrame" name="resultFrame"></iframe>

        <form id="postForm" target="resultFrame" method="POST" style="display:none;">
          <input name="round" id="f_round" />
          <input name="name" id="f_name" />
          <textarea name="picks" id="f_picks"></textarea>
        </form>
      </section>

      <!-- NFC -->
      <section class="side" id="nfcSide">
        <div class="sideHeader">
          <h2>NFC</h2>
          <div class="muted" style="font-size:12px;">WC → DIV → CONF</div>
        </div>
        <div class="roundLabels">
          <div>Conference</div><div>Divisional</div><div>Wild Card</div>
        </div>

        <div class="sideGrid" id="nfcGrid">
          <svg class="connector" id="nfcLines"></svg>
          <div class="slot" id="nfc_wc1"></div>
          <div class="slot" id="nfc_wc2"></div>
          <div class="slot" id="nfc_wc3"></div>
          <div class="slot" id="nfc_div1"></div>
          <div class="slot" id="nfc_div2"></div>
          <div class="slot" id="nfc_conf1"></div>
        </div>

        <div class="note">#1 seed Seattle Seahawks has a bye.</div>
      </section>
    </div>
  </div>

<script>
  // Paste your Apps Script Web App URL (must end in /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbxpad-m4_a0J69IAYBc1GIFIoMgzqqL3m_-DRy6yNuZGmh_cfp9_HgRo1vuEoR2qeAH/exec";

  // Team data (seed -> name + abbreviation for logo)
  const TEAMS = {
    AFC: {
      1: { name:"Denver Broncos", abbr:"den" },
      2: { name:"New England Patriots", abbr:"ne" },
      3: { name:"Jacksonville Jaguars", abbr:"jax" },
      4: { name:"Pitsburgh Steelers", abbr:"pit" },
      5: { name:"Houston Texans", abbr:"hou" },
      6: { name:"Buffalo Bills", abbr:"buf" },
      7: { name:"LA Chargers", abbr:"lac" }
    },
    NFC: {
      1: { name:"Seattle Seahawks", abbr:"sea" },
      2: { name:"Chicago Bears", abbr:"chi" },
      3: { name:"Philidelphia Eagles", abbr:"phi" },
      4: { name:"Carolina Panthers", abbr:"car" },
      5: { name:"LA Rams", abbr:"lar" },
      6: { name:"SF 49ers", abbr:"sf" },
      7: { name:"Greenbay Packers", abbr:"gb" }
    }
  };

  function logoUrl(abbr){
    return `https://a.espncdn.com/i/teamlogos/nfl/500/${abbr}.png`;
  }

  // WC matchups: 2v7, 3v6, 4v5
  const WC_MATCHUPS = [[2,7],[3,6],[4,5]];

  // State
  const winnerSeedByGameId = {}; // CONF games store seed numbers; SB stores "AFC:x" / "NFC:y"
  const scoresByGameId = {};     // { gameId: { seedKey: number } }

  // Helpers
  function assertValidApiUrl(url){
    if (!url || url === "PASTE_YOUR_SCRIPT_URL_HERE") throw new Error("Paste your Apps Script /exec URL into API_URL.");
    if (!url.startsWith("https://script.google.com/macros/s/")) throw new Error("Bad API_URL");
    if (!url.endsWith("/exec")) throw new Error("API_URL must end with /exec");
  }
  function teamObj(conf, seed){ return TEAMS[conf]?.[seed] ?? null; }
  function teamName(conf, seed){ return teamObj(conf, seed)?.name ?? null; }
  function teamAbbr(conf, seed){ return teamObj(conf, seed)?.abbr ?? null; }

  function betterSeedHomePair(a,b){ return a < b ? [a,b] : [b,a]; }

  function getScore(gameId, seedKey){
    return (scoresByGameId[gameId] && scoresByGameId[gameId][seedKey] !== undefined)
      ? scoresByGameId[gameId][seedKey]
      : "";
  }
  function setScore(gameId, seedKey, val){
    if (!scoresByGameId[gameId]) scoresByGameId[gameId] = {};
    scoresByGameId[gameId][seedKey] = val;
  }
  function clearGameState(gameId){
    delete winnerSeedByGameId[gameId];
    delete scoresByGameId[gameId];
  }

  // Reseeding
  function computeDivisionalGames(conf){
    const wcWinners = WC_MATCHUPS.map((_, idx) => winnerSeedByGameId[`WC_${conf}_${idx+1}`] ?? null);
    if (wcWinners.some(x => x === null)) return [];
    const remaining = [1, ...wcWinners].slice().sort((x,y)=>x-y);
    const top = 1;
    const lowest = remaining[remaining.length - 1];
    const others = remaining.filter(s => s !== top && s !== lowest);
    const g1 = betterSeedHomePair(top, lowest);
    const g2 = betterSeedHomePair(others[0], others[1]);
    return [
      { id:`DIV_${conf}_1`, conf, round:"Divisional", home:g1[0], away:g1[1] },
      { id:`DIV_${conf}_2`, conf, round:"Divisional", home:g2[0], away:g2[1] }
    ];
  }

  function computeConferenceGame(conf){
    const div = computeDivisionalGames(conf);
    if (div.length !== 2) return null;
    const w1 = winnerSeedByGameId[div[0].id] ?? null;
    const w2 = winnerSeedByGameId[div[1].id] ?? null;
    if (w1 === null || w2 === null) return null;
    const [home, away] = betterSeedHomePair(w1, w2);
    return { id:`CONF_${conf}_1`, conf, round:"Conference", home, away };
  }

  function computeSuperBowlGame(){
    const afcC = computeConferenceGame("AFC");
    const nfcC = computeConferenceGame("NFC");
    if (!afcC || !nfcC) return null;
    const afcChamp = winnerSeedByGameId[afcC.id] ?? null;
    const nfcChamp = winnerSeedByGameId[nfcC.id] ?? null;
    if (afcChamp === null || nfcChamp === null) return null;
    return { id:"SB_1", conf:"SB", round:"Super Bowl", home:{conf:"AFC", seed:afcChamp}, away:{conf:"NFC", seed:nfcChamp} };
  }

  // Clear downstream if participants change
  function reconcileDownstream(){
    ["AFC","NFC"].forEach(conf=>{
      const div = computeDivisionalGames(conf);
      const divIds = [`DIV_${conf}_1`,`DIV_${conf}_2`];

      if (div.length !== 2){
        divIds.forEach(clearGameState);
        clearGameState(`CONF_${conf}_1`);
        clearGameState("SB_1");
        return;
      }

      div.forEach(g=>{
        const stored = scoresByGameId[g.id];
        const winner = winnerSeedByGameId[g.id];
        const valid = new Set([g.home, g.away]);
        if (stored){
          const keys = Object.keys(stored).map(k=>Number(k));
          if (keys.some(s => !valid.has(s))) clearGameState(g.id);
        }
        if (winner !== undefined && !valid.has(winner)) clearGameState(g.id);
      });

      const cg = computeConferenceGame(conf);
      const cid = `CONF_${conf}_1`;
      if (!cg){
        clearGameState(cid);
        clearGameState("SB_1");
        return;
      }
      const storedC = scoresByGameId[cid];
      const winnerC = winnerSeedByGameId[cid];
      const validC = new Set([cg.home, cg.away]);
      if (storedC){
        const keys = Object.keys(storedC).map(k=>Number(k));
        if (keys.some(s => !validC.has(s))) clearGameState(cid);
      }
      if (winnerC !== undefined && !validC.has(winnerC)) clearGameState(cid);
    });

    const sb = computeSuperBowlGame();
    if (!sb){
      clearGameState("SB_1");
      return;
    }
    const storedSB = scoresByGameId["SB_1"];
    const winnerSB = winnerSeedByGameId["SB_1"];
    const sbKeys = new Set([`AFC:${sb.home.seed}`, `NFC:${sb.away.seed}`]);
    if (storedSB){
      const keys = Object.keys(storedSB);
      if (keys.some(k => !sbKeys.has(k))) clearGameState("SB_1");
    }
    if (winnerSB !== undefined && !sbKeys.has(winnerSB)) clearGameState("SB_1");
  }

  // Rendering (simple)
  function renderGameInto(slotEl, game, side){
    // side = "AFC" or "NFC" or "SB"
    slotEl.innerHTML = "";
    const gid = game.id;

    // Not ready placeholder
    if (game.conf !== "SB" && (game.home == null || game.away == null)){
      slotEl.innerHTML = `<div class="game"><div class="placeholder">Waiting on picks…</div></div>`;
      return;
    }
    if (game.conf === "SB"){
      const sb = computeSuperBowlGame();
      if (!sb){
        slotEl.innerHTML = `<div class="game"><div class="placeholder">Pick both champions…</div></div>`;
        return;
      }
      game = sb;
    }

    let homeKey, awayKey, homeText, awayText, homeLogo, awayLogo;

    if (game.conf !== "SB"){
      homeKey = game.home;
      awayKey = game.away;
      homeText = `#${game.home} ${teamName(game.conf, game.home)}`;
      awayText = `#${game.away} ${teamName(game.conf, game.away)}`;
      homeLogo = logoUrl(teamAbbr(game.conf, game.home));
      awayLogo = logoUrl(teamAbbr(game.conf, game.away));
    } else {
      homeKey = `AFC:${game.home.seed}`;
      awayKey = `NFC:${game.away.seed}`;
      homeText = `${teamName("AFC", game.home.seed)}`;
      awayText = `${teamName("NFC", game.away.seed)}`;
      homeLogo = logoUrl(teamAbbr("AFC", game.home.seed));
      awayLogo = logoUrl(teamAbbr("NFC", game.away.seed));
    }

    const picked = winnerSeedByGameId[gid];

    const card = document.createElement("div");
    card.className = "game";
    card.innerHTML = `
      <div class="match">
        <div class="pick ${picked === homeKey ? "picked" : ""}" data-pick="home" title="${homeText}">
          <img class="logo" src="${homeLogo}" alt="">
          <div class="label">${homeText}</div>
        </div>
        <input class="score" type="number" min="0" max="99" step="1" inputmode="numeric" data-score="home" value="${getScore(gid, homeKey)}">
      </div>

      <div class="match">
        <div class="pick ${picked === awayKey ? "picked" : ""}" data-pick="away" title="${awayText}">
          <img class="logo" src="${awayLogo}" alt="">
          <div class="label">${awayText}</div>
        </div>
        <input class="score" type="number" min="0" max="99" step="1" inputmode="numeric" data-score="away" value="${getScore(gid, awayKey)}">
      </div>
    `;

    card.querySelectorAll(".pick").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const which = btn.getAttribute("data-pick");
        winnerSeedByGameId[gid] = (which === "home") ? homeKey : awayKey;
        reconcileDownstream();
        renderAll();
      });
    });

    card.querySelectorAll("input.score").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const which = inp.getAttribute("data-score");
        const key = (which === "home") ? homeKey : awayKey;
        const v = inp.value === "" ? "" : Number(inp.value);
        setScore(gid, key, v);
      });
    });

    slotEl.appendChild(card);
  }

  function renderSide(conf){
    // Wild card slots
    WC_MATCHUPS.forEach((pair, idx)=>{
      const [a,b] = pair;
      const [home, away] = betterSeedHomePair(a,b);
      renderGameInto(
        document.getElementById(`${conf.toLowerCase()}_wc${idx+1}`),
        { id:`WC_${conf}_${idx+1}`, conf, round:"Wild Card", home, away },
        conf
      );
    });

    // Divisional slots
    const div = computeDivisionalGames(conf);
    renderGameInto(
      document.getElementById(`${conf.toLowerCase()}_div1`),
      div[0] ?? { id:`DIV_${conf}_1`, conf, round:"Divisional", home:null, away:null },
      conf
    );
    renderGameInto(
      document.getElementById(`${conf.toLowerCase()}_div2`),
      div[1] ?? { id:`DIV_${conf}_2`, conf, round:"Divisional", home:null, away:null },
      conf
    );

    // Conference slot
    const cg = computeConferenceGame(conf);
    renderGameInto(
      document.getElementById(`${conf.toLowerCase()}_conf1`),
      cg ?? { id:`CONF_${conf}_1`, conf, round:"Conference", home:null, away:null },
      conf
    );
  }

  function renderSuperBowl(){
    const el = document.getElementById("sb_game");
    el.innerHTML = "";
    const tmp = document.createElement("div");
    el.appendChild(tmp);
    renderGameInto(tmp, { id:"SB_1", conf:"SB", round:"Super Bowl" }, "SB");
  }

  // Connector lines
  function drawSideLines(conf){
    const svg = document.getElementById(`${conf.toLowerCase()}Lines`);
    const grid = document.getElementById(`${conf.toLowerCase()}Grid`);
    svg.innerHTML = "";

    const box = grid.getBoundingClientRect();

    function center(el){
      const r = el.getBoundingClientRect();
      return { cx: r.left + r.width/2, cy: r.top + r.height/2, left:r.left, right:r.right, top:r.top, bottom:r.bottom };
    }

    // AFC flows left->right (use from right edge -> left edge)
    // NFC flows right->left (use from left edge -> right edge)
    function pointFrom(el){
      const r = el.getBoundingClientRect();
      if (conf === "AFC"){
        return { x: (r.right - box.left), y: (r.top + r.height/2 - box.top) };
      } else {
        return { x: (r.left - box.left), y: (r.top + r.height/2 - box.top) };
      }
    }
    function pointTo(el){
      const r = el.getBoundingClientRect();
      if (conf === "AFC"){
        return { x: (r.left - box.left), y: (r.top + r.height/2 - box.top) };
      } else {
        return { x: (r.right - box.left), y: (r.top + r.height/2 - box.top) };
      }
    }

    function drawPath(fromEl, toEl){
      if (!fromEl || !toEl) return;
      const a = pointFrom(fromEl);
      const b = pointTo(toEl);

      // bend in the direction of flow
      const midX = conf === "AFC"
        ? Math.min(a.x + (b.x - a.x) * 0.55, b.x - 10)
        : Math.max(a.x + (b.x - a.x) * 0.55, b.x + 10);

      const d = `M ${a.x} ${a.y} L ${midX} ${a.y} L ${midX} ${b.y} L ${b.x} ${b.y}`;
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d);
      path.setAttribute("fill","none");
      path.setAttribute("stroke", getComputedStyle(document.documentElement).getPropertyValue('--line').trim() || "#cfcfcf");
      path.setAttribute("stroke-width","2");
      path.setAttribute("stroke-linecap","round");
      svg.appendChild(path);
    }

    // WC -> DIV and DIV -> CONF
    const p = (id)=>document.getElementById(id);

    drawPath(p(`${conf.toLowerCase()}_wc1`), p(`${conf.toLowerCase()}_div1`));
    drawPath(p(`${conf.toLowerCase()}_wc2`), p(`${conf.toLowerCase()}_div1`));
    drawPath(p(`${conf.toLowerCase()}_wc2`), p(`${conf.toLowerCase()}_div2`));
    drawPath(p(`${conf.toLowerCase()}_wc3`), p(`${conf.toLowerCase()}_div2`));

    drawPath(p(`${conf.toLowerCase()}_div1`), p(`${conf.toLowerCase()}_conf1`));
    drawPath(p(`${conf.toLowerCase()}_div2`), p(`${conf.toLowerCase()}_conf1`));
  }

  function drawAllLines(){
    requestAnimationFrame(()=>{
      drawSideLines("AFC");
      drawSideLines("NFC");
    });
  }

  // Submit
  function collectAllGamesResolved(){
    const games = [];
    ["AFC","NFC"].forEach(conf=>{
      WC_MATCHUPS.forEach((pair, idx)=>{
        const [a,b] = pair;
        const [home,away] = betterSeedHomePair(a,b);
        games.push({ id:`WC_${conf}_${idx+1}`, conf, round:"Wild Card", home, away, type:"CONF" });
      });
      computeDivisionalGames(conf).forEach(g => games.push({ ...g, type:"CONF" }));
      const cg = computeConferenceGame(conf);
      if (cg) games.push({ ...cg, type:"CONF" });
    });
    const sb = computeSuperBowlGame();
    if (sb) games.push({ ...sb, type:"SB" });
    return games;
  }

  function validateAndBuildSubmission(){
    const name = document.getElementById("name").value.trim();
    if (!name) throw new Error("Please enter your name.");

    const games = collectAllGamesResolved();
    const picks = [];

    for (const g of games){
      const gid = g.id;
      const w = winnerSeedByGameId[gid];
      if (w === undefined) throw new Error(`Pick a winner for: ${g.round} (${g.conf})`);

      if (g.type === "CONF"){
        const sHome = getScore(gid, g.home);
        const sAway = getScore(gid, g.away);
        if (sHome === "" || sAway === "") throw new Error(`Enter both scores for: ${g.round} (${g.conf})`);

        const a = Number(sHome), b = Number(sAway);
        if (!Number.isInteger(a) || !Number.isInteger(b) || a < 0 || b < 0 || a > 99 || b > 99) {
          throw new Error(`Invalid score in: ${g.round} (${g.conf})`);
        }
        if (a === b) throw new Error(`No ties allowed: ${g.round} (${g.conf})`);

        const actualWinner = (a > b) ? g.home : g.away;
        if (w !== actualWinner) throw new Error(`Winner mismatch in ${g.round} (${g.conf}).`);

        picks.push({
          bracketType:"FULL",
          round:g.round,
          conf:g.conf,
          homeSeed:g.home,
          awaySeed:g.away,
          homeTeam:teamName(g.conf, g.home),
          awayTeam:teamName(g.conf, g.away),
          homeScore:a,
          awayScore:b,
          winnerSeed:w,
          winnerTeam:teamName(g.conf, w)
        });

      } else {
        const sb = computeSuperBowlGame();
        const homeKey = `AFC:${sb.home.seed}`;
        const awayKey = `NFC:${sb.away.seed}`;

        const sHome = getScore(gid, homeKey);
        const sAway = getScore(gid, awayKey);
        if (sHome === "" || sAway === "") throw new Error("Enter both scores for: Super Bowl");

        const a = Number(sHome), b = Number(sAway);
        if (!Number.isInteger(a) || !Number.isInteger(b) || a < 0 || b < 0 || a > 99 || b > 99) {
          throw new Error("Invalid Super Bowl score.");
        }
        if (a === b) throw new Error("No ties allowed: Super Bowl");

        const actualWinner = (a > b) ? homeKey : awayKey;
        if (w !== actualWinner) throw new Error("Winner mismatch in Super Bowl.");

        picks.push({
          bracketType:"FULL",
          round:"Super Bowl",
          conf:"SB",
          homeTeam:`AFC — ${teamName("AFC", sb.home.seed)}`,
          awayTeam:`NFC — ${teamName("NFC", sb.away.seed)}`,
          homeScore:a,
          awayScore:b,
          winner:w,
          winnerTeam:(w === homeKey)
            ? `AFC — ${teamName("AFC", sb.home.seed)}`
            : `NFC — ${teamName("NFC", sb.away.seed)}`
        });
      }
    }

    return { name, picks };
  }

  document.getElementById("submitBtn").addEventListener("click", ()=>{
    const status = document.getElementById("status");
    status.className = "status muted";
    status.textContent = "";

    try{
      assertValidApiUrl(API_URL);
      const { name, picks } = validateAndBuildSubmission();

      const form = document.getElementById("postForm");
      form.action = API_URL;
      document.getElementById("f_round").value = "Full Bracket";
      document.getElementById("f_name").value = name;
      document.getElementById("f_picks").value = JSON.stringify(picks);

      form.submit();
      status.className = "status ok";
      status.textContent = "Submitted ✅ (Full Bracket sent to Google Sheet)";
    } catch(err){
      status.className = "status error";
      status.textContent = err.message || String(err);
    }
  });

  function renderAll(){
    renderSide("AFC");
    renderSide("NFC");
    renderSuperBowl();
    drawAllLines();
  }

  window.addEventListener("resize", drawAllLines);

  renderAll();
</script>
</body>
</html>